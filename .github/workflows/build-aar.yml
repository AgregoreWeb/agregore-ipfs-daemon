name: "Build AAR with docker"

on:
  push:
    paths-ignore:
      - "**.md"
      - "LICENSE*"
    branches:
      - "main"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - run: mkdir -p ~/image-cache
      - name: Get digest
        id: get-digest
        run: |
          echo "::set-output name=digest::$(docker manifest inspect makeworld/gomobile-android:latest -v | jq -r '.Descriptor.digest' | cut -d: -f2)"
        shell: bash

      - name: Load image cache
        id: image-cache
        uses: actions/cache@v3
        with:
          path: ~/image-cache
          key: image-cache-${{ steps.get-digest.outputs.digest }}

      - name: Load Go cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-

      - name: Download image if cache is outdated
        if: steps.image-cache.outputs.cache-hit != 'true'
        run: |
          docker pull makeworld/gomobile-android:latest
          docker save -o ~/image-cache/gomobile-android.tar makeworld/gomobile-android

      - name: Use cache if current
        if: steps.image-cache.outputs.cache-hit == 'true'
        run: docker load -i ~/image-cache/gomobile-android.tar

      - name: docker run
        run: docker run --rm -v ${GITHUB_WORKSPACE}:/module -v ~/go/pkg/mod:/go/pkg/mod makeworld/gomobile-android bind -target=android/arm -javapkg=moe.mauve.agregore.ipfs -o agregore-ipfs-daemon_${GITHUB_SHA}.aar ./gateway

      - name: Upload assets
        uses: actions/upload-artifact@v3
        with:
          name: AAR
          path: agregore-ipfs-daemon_*.aar
          if-no-files-found: error
